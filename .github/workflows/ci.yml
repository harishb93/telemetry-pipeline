name: CI

on:
  push:
    branches: [ "**" ]  # Run on all branches
  pull_request:
    branches: [ "**" ]  # Run on all pull requests

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: ['1.24']
    
    env:
      GOTOOLCHAIN: local
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Install dependencies
      run: make deps
    
    - name: Run tests
      run: make test
    
    - name: Generate coverage report
      run: make coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Run linting
      run: make lint
    
    - name: Generate documentation
      run: make docs
    
    - name: Build all components
      run: make build
    
    - name: Run integration tests
      run: make test-integration
    
    - name: Generate CI Summary
      if: always()
      run: |
        echo "## 🔍 CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ All tests passed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
        if [ -f coverage.out ]; then
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "📊 Code Coverage: $COVERAGE" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Go Version**: ${{ matrix.go-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **OS**: ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  docker-build:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    env:
      GOTOOLCHAIN: local
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker images
      run: make docker-build
    
    - name: Test Docker containers
      run: |
        # Check if docker-compose file exists
        if [ -f "deploy/docker/docker-compose.yml" ]; then
          # Start the services
          cd deploy/docker
          docker compose up -d
          
          # Wait for services to be ready
          sleep 30
          
          # Run basic health checks (these may fail in test environment, which is ok)
          curl -f http://localhost:8080/health || echo "Telemetry Collector health check failed (expected in test)"
          curl -f http://localhost:8081/health || echo "API GW health check failed (expected in test)"
          curl -f http://localhost:9090/health || echo "MQ Service health check failed (expected in test)"
          
          # Stop services
          docker compose down
        else
          echo "Docker compose file not found, skipping container tests"
        fi

  security:
    runs-on: ubuntu-latest
    
    env:
      GOTOOLCHAIN: local
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Run Security Scanning
      run: |
        # Use go vet for basic security checks
        go vet ./...
        
        # Use staticcheck for additional security analysis
        go install honnef.co/go/tools/cmd/staticcheck@latest
        staticcheck ./...
    
    - name: Run govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  code-quality:
    runs-on: ubuntu-latest
    
    env:
      GOTOOLCHAIN: local
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Run code quality checks
      run: |
        # Run go fmt to check formatting
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Code is not properly formatted:"
          gofmt -s -l .
          exit 1
        fi
        
        # Run go vet for code analysis
        go vet ./...
        
        # Run staticcheck for additional analysis
        go install honnef.co/go/tools/cmd/staticcheck@latest
        staticcheck ./...